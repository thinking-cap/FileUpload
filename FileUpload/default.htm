<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script type="text/javascript" src="Scripts/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="Scripts/bootstrap.bundle.min.js"></script>
    <link type="text/css" media="screen" rel="stylesheet" href="Content/bootstrap.css"/>
</head>
<body>
    <div class="container">
        <div class="jumbotron">
            <h2>Javascript File Upload </h2>
            <p>
                This uses the JavaScript FileReader api and sends the file ~1.4mb at time to a handler that creates the file on the server.                 
            </p>
            <p>This approach gets around the browser timing out on large files.</p>
        </div>
        <div class="row justify-content-md-center">
            <div class="col-md-6">
                <div class="progress" style="visibility:hidden;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated file-upload" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
        <div class="row justify-content-md-center">
            <div class="col-md-6">
               
                    <input id="file-upload" class="form-control-file" type="file" name="dbi_import_file" />
                    <input id="file-upload-submit" class="button button-primary" type="submit" value="Upload" />
               
                <div style="display:none" class="file-more">Add Another</div>
            </div>
        </div>
    </div>
    <script type="text/javascript">

       

        (function ($) {

            var reader = {};
            var file = {};
            var slice_size = 1000 * 1024;

            function start_upload(event) {
                event.preventDefault();
                $('.progress').css('visibility', 'visible');
                reader = new FileReader();
                file = document.querySelector('#file-upload').files[0];
                $('#file-upload').hide();
                $('#file-upload-submit').hide();

                upload_file(0);
                return false;
            }

            $('.file-more').on('click', function () {
                $(this).hide();
                $('#file-upload').show();
                $('#file-upload-submit').show();
                $('.progress').css('visibility', 'hidden');
                $('.progress-bar.file-upload').css('width', '0%').text('0%');
            });
            $('#file-upload-submit').on('click', start_upload);

            function upload_file(start) {
                var action = (start === 0) ? 'create' : 'append';
                var next_slice = start + slice_size + 1;
                var blob = file.slice(start, next_slice);

                reader.onloadend = function (event) {
                    if (event.target.readyState !== FileReader.DONE) {
                        return;
                    }

                    $.ajax({
                        url: 'upload.ashx',
                        type: 'POST',
                        dataType: 'json',
                        cache: false,
                        data: {
                            action: action,
                            file_data: event.target.result,
                            file: file.name,
                            file_type: file.type
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(jqXHR, textStatus, errorThrown);
                        },
                        success: function (data) {
                            var size_done = start + slice_size;
                            var percent_done = Math.floor((size_done / file.size) * 100);

                            if (next_slice < file.size) {
                                // Update upload progress
                               $('.progress-bar.file-upload').css('width', percent_done+'%').text(percent_done+'%');
                                // More to upload, call function recursively
                                upload_file(next_slice);
                            } else {
                                // Update upload progress
                                $('.file-more').show();
                                $('.progress-bar.file-upload').css('width', '100%').text('100%');
                            }
                        }
                    });
                };

                reader.readAsDataURL(blob);
            }

        })(jQuery);

    </script>


</body>
</html>